<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="erp.chain.mapper.SpecGroupMapper">
    <insert id="insert" parameterType="map" useGeneratedKeys="true" keyProperty="id" >
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Fri Nov 04 15:05:01 CST 2016.
        -->
        insert into spec_group (id, code, name,
        tenant_id, branch_id, is_deleted,
        create_by, create_at, last_update_by,
        last_update_at, version, local_id
        )
        values (#{id,jdbcType=BIGINT}, #{code,jdbcType=CHAR}, #{name,jdbcType=VARCHAR},
        #{tenantId,jdbcType=BIGINT},#{branchId,jdbcType=BIGINT},#{isDeleted,jdbcType=BIT},
        #{createBy,jdbcType=VARCHAR}, #{createAt,jdbcType=TIMESTAMP}, #{lastUpdateBy,jdbcType=VARCHAR},
        #{lastUpdateAt,jdbcType=TIMESTAMP},#{version,jdbcType=BIGINT}, #{localId,jdbcType=BIGINT}
        )
    </insert>
    <update id="update" parameterType="map" >
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Fri Nov 04 15:05:01 CST 2016.
        -->
        update spec_group
        <set >
            <if test="code != null" >
                code = #{code,jdbcType=CHAR},
            </if>
            <if test="name != null" >
                name = #{name,jdbcType=VARCHAR},
            </if>
            <if test="tenantId != null" >
                tenant_id = #{tenantId,jdbcType=BIGINT},
            </if>
            <if test="branchId != null" >
                branch_id = #{branchId,jdbcType=BIGINT},
            </if>
            <if test="createBy != null" >
                create_by = #{createBy,jdbcType=VARCHAR},
            </if>
            <if test="createAt != null" >
                create_at = #{createAt,jdbcType=TIMESTAMP},
            </if>
            <if test="lastUpdateBy != null" >
                last_update_by = #{lastUpdateBy,jdbcType=VARCHAR},
            </if>
            <if test="lastUpdateAt != null" >
                last_update_at = #{lastUpdateAt,jdbcType=TIMESTAMP},
            </if>
            <if test="isDeleted != null" >
                is_deleted = #{isDeleted,jdbcType=BIT},
            </if>
            <if test="version != null" >
                version = #{version,jdbcType=BIGINT},
            </if>
            <if test="localId != null" >
                local_id = #{localId,jdbcType=BIGINT},
            </if>
        </set>
        where id = #{id,jdbcType=BIGINT}
    </update>
    <select id="branchSpecGroupList" parameterType="map" resultType="erp.chain.domain.SpecGroup">
        <!--SELECT * FROM spec_group WHERE tenant_id=${tenantId} AND is_deleted=0
        <if test="onlySelf == 0">
            AND (branch_id=${branchId} OR branch_id=(SELECT id FROM branch WHERE tenant_id=${tenantId} AND branch_type=0 AND is_deleted=0))
        </if>
        <if test="onlySelf == 1">
            AND branch_id=${branchId}
        </if>
        <if test="codeName!=null and codeName!=''">
            AND (code LIKE '%${codeName}%' OR name LIKE '%${codeName}%')
        </if>-->
        SELECT * FROM (
        SELECT sg.*, GROUP_CONCAT(gs.property SEPARATOR '、') goods_spec_name FROM spec_group sg INNER JOIN goods_spec gs ON sg.id = gs.group_id
        AND sg.is_deleted = 0 AND gs.is_deleted = 0
        <if test="onlySelf == 0">
            <if test="branchType==0">
                AND gs.branch_id=${branchId}
            </if>
            <if test="branchType!=0">
                AND (gs.branch_id=${branchId} OR gs.branch_id=(SELECT id FROM branch WHERE tenant_id=${tenantId} AND branch_type=0 AND is_deleted=0))
            </if>
        </if>
        AND sg.tenant_id = ${tenantId}
        <if test="onlySelf == 0">
            <if test="branchType==0">
                AND sg.branch_id=${branchId}
            </if>
            <if test="branchType!=0">
                AND (sg.branch_id=${branchId} OR sg.branch_id=(SELECT id FROM branch WHERE tenant_id=${tenantId} AND branch_type=0 AND is_deleted=0))
            </if>
        </if>
        <if test="onlySelf == 1">
            AND sg.branch_id=${branchId}
        </if>
        GROUP BY sg.id
        UNION
        SELECT sg.*,null FROM spec_group sg WHERE sg.tenant_id = ${tenantId}
        <if test="onlySelf == 0">
            <if test="branchType==0">
                AND sg.branch_id=${branchId}
            </if>
            <if test="branchType!=0">
                AND (sg.branch_id=${branchId} OR sg.branch_id=(SELECT id FROM branch WHERE tenant_id=${tenantId} AND branch_type=0 AND is_deleted=0))
            </if>
        </if>
        <if test="onlySelf == 1">
            AND sg.branch_id=${branchId}
        </if>
        AND sg.is_deleted = 0) t  WHERE  1=1
        <if test="codeName!=null and codeName!=''">
            AND (t.code LIKE '%${codeName}%' OR t.name LIKE '%${codeName}%')
        </if>
        GROUP BY t.id
        <if test="offset != null and rows != null">
            LIMIT ${offset},${rows}
        </if>
    </select>
    <select id="branchSpecGroupListCount" parameterType="map" resultType="Long">
        SELECT count(1) FROM spec_group WHERE tenant_id=${tenantId} AND is_deleted=0
        <if test="onlySelf == 0">
            AND (branch_id=${branchId} OR branch_id=(SELECT id FROM branch WHERE tenant_id=${tenantId} AND branch_type=0 AND is_deleted=0))
        </if>
        <if test="onlySelf == 1">
            AND branch_id=${branchId}
        </if>
        <if test="branchId!=null and branchId!=''">
            AND branch_id=${branchId}
        </if>
        <if test="codeName!=null and codeName!=''">
            AND (code LIKE '%${codeName}%' OR name LIKE '%${codeName}%')
        </if>
    </select>
    <select id="specGroupList" parameterType="map" resultType="erp.chain.domain.SpecGroup">
        <!--SELECT * FROM spec_group WHERE tenant_id=${tenantId} AND is_deleted=0
        <if test="onlySelf == 0">
            <if test="branchType==0">
                AND branch_id=${branchId}
            </if>
            <if test="branchType!=0">
                AND (branch_id=${branchId} OR branch_id=(SELECT id FROM branch WHERE tenant_id=${tenantId} AND branch_type=0 AND is_deleted=0))
            </if>
        </if>
        <if test="onlySelf == 1">
            AND branch_id=${branchId}
        </if>
        <if test="codeName!=null and codeName!=''">
            AND (code LIKE '%${codeName}%' OR name LIKE '%${codeName}%')
        </if>-->
        SELECT * FROM (
        SELECT sg.*, GROUP_CONCAT(gs.property SEPARATOR '、') goods_spec_name FROM spec_group sg INNER JOIN goods_spec gs ON sg.id = gs.group_id
        AND sg.is_deleted = 0 AND gs.is_deleted = 0
        <if test="onlySelf == 0">
            <if test="branchType==0">
                AND gs.branch_id=${branchId}
            </if>
            <if test="branchType!=0">
                AND (gs.branch_id=${branchId} OR gs.branch_id=(SELECT id FROM branch WHERE tenant_id=${tenantId} AND branch_type=0 AND is_deleted=0))
            </if>
        </if>
        AND sg.tenant_id = ${tenantId}
        <if test="onlySelf == 0">
            <if test="branchType==0">
                AND sg.branch_id=${branchId}
            </if>
            <if test="branchType!=0">
                AND (sg.branch_id=${branchId} OR sg.branch_id=(SELECT id FROM branch WHERE tenant_id=${tenantId} AND branch_type=0 AND is_deleted=0))
            </if>
        </if>
        <if test="onlySelf == 1">
            AND sg.branch_id=${branchId}
        </if>
        GROUP BY sg.id
        UNION
        SELECT sg.*,null FROM spec_group sg WHERE sg.tenant_id = ${tenantId}
        <if test="onlySelf == 0">
            <if test="branchType==0">
                AND sg.branch_id=${branchId}
            </if>
            <if test="branchType!=0">
                AND (sg.branch_id=${branchId} OR sg.branch_id=(SELECT id FROM branch WHERE tenant_id=${tenantId} AND branch_type=0 AND is_deleted=0))
            </if>
        </if>
        <if test="onlySelf == 1">
            AND sg.branch_id=${branchId}
        </if>
        AND sg.is_deleted = 0) t WHERE  1=1
        <if test="codeName!=null and codeName!=''">
            AND (t.code LIKE '%${codeName}%' OR t.name LIKE '%${codeName}%')
        </if>
        GROUP BY t.id
        <if test="offset != null and rows != null">
            LIMIT ${offset},${rows}
        </if>
    </select>

    <select id="specGroupListCount" parameterType="map" resultType="Long">
        SELECT count(1) FROM spec_group WHERE tenant_id=${tenantId} AND is_deleted=0
        <if test="onlySelf == 0">
            <if test="branchType==0">
                AND branch_id=${branchId}
            </if>
            <if test="branchType!=0">
                AND (branch_id=${branchId} OR branch_id=(SELECT id FROM branch WHERE tenant_id=${tenantId} AND branch_type=0 AND is_deleted=0))
            </if>
        </if>
        <if test="onlySelf == 1">
            AND branch_id=${branchId}
        </if>
        <if test="codeName!=null and codeName!=''">
            AND (code LIKE '%${codeName}%' OR name LIKE '%${codeName}%')
        </if>
    </select>

    <select id="findByIdAndTenantId" resultType="erp.chain.domain.SpecGroup">
        SELECT * FROM spec_group WHERE tenant_id=${tenantId} AND id=#{id} AND is_deleted=0
    </select>

    <select id="checkGroupName" resultType="long" >
        SELECT count(1) FROM spec_group g WHERE g.is_deleted=0 AND g.tenant_id=${tenantId} AND g.name=#{groupName}
        <if test="id != null and id!=''">
            <![CDATA[AND g.id!=#{id}]]>
        </if>
        <if test="business != null and business == 6">
            AND branch_id = ${branchId}
        </if>
    </select>

    <select id="getGroupCode" resultType="String">
        SELECT MAX(b.code+0) FROM spec_group b WHERE b.tenant_id=${tenantId} AND b.is_deleted=0
    </select>

    <select id="countByGroupId" resultType="long">
        SELECT COUNT(1) FROM goods_spec WHERE group_id=#{groupId} AND is_deleted=0 AND tenant_id=${tenantId}
    </select>
</mapper>