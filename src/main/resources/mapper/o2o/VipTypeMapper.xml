<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="erp.chain.mapper.o2o.VipTypeMapper" >
  <resultMap id="BaseResultMap" type="erp.chain.domain.o2o.VipType" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Fri Nov 04 15:05:01 CST 2016.
    -->
    <id column="id" property="id" jdbcType="BIGINT" />
    <result column="tenant_id" property="tenantId" jdbcType="BIGINT" />
    <result column="type_code" property="typeCode" jdbcType="VARCHAR" />
    <result column="type_name" property="typeName" jdbcType="VARCHAR" />
    <result column="preferential_policy" property="preferentialPolicy" jdbcType="BIGINT" />
    <result column="points_factor" property="pointsFactor" jdbcType="DECIMAL" />
    <result column="score_usage" property="scoreUsage" jdbcType="INTEGER" />
    <result column="mem_price_used" property="memPriceUsed" jdbcType="BIGINT" />
    <result column="discount_rate" property="discountRate" jdbcType="DECIMAL" />
    <result column="to_save_points" property="toSavePoints" jdbcType="BIGINT" />
    <result column="is_package_disc" property="isPackageDisc" jdbcType="BIGINT" />
    <result column="is_promotion_disc" property="isPromotionDisc" jdbcType="BIGINT" />
    <result column="is_online_default" property="isOnlineDefault" jdbcType="BIT" />
    <result column="create_by" property="createBy" jdbcType="VARCHAR" />
    <result column="create_at" property="createAt" jdbcType="TIMESTAMP" />
    <result column="last_update_by" property="lastUpdateBy" jdbcType="VARCHAR" />
    <result column="last_update_at" property="lastUpdateAt" jdbcType="TIMESTAMP" />
    <result column="is_deleted" property="isDeleted" jdbcType="BIT" />
    <result column="version" property="version" jdbcType="BIGINT" />
    <result column="local_id" property="localId" jdbcType="BIGINT" />
    <result column="branch_id" property="branchId" jdbcType="BIGINT" />
  </resultMap>

  <insert id="insert" parameterType="map" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Fri Nov 04 15:05:01 CST 2016.
    -->
    insert into vip_type (id, tenant_id, type_code, 
      type_name, preferential_policy, points_factor, 
      score_usage, mem_price_used, discount_rate, 
      to_save_points, is_package_disc, is_promotion_disc, 
      is_online_default, create_by, create_at, 
      last_update_by, last_update_at, is_deleted, 
      version, branch_id, allow_refund, deposit,
      auto_upgrade,curr_level,upgrade_type,upgrade_limit
      )
    values (#{id,jdbcType=BIGINT}, #{tenantId,jdbcType=BIGINT}, #{typeCode,jdbcType=VARCHAR}, 
      #{typeName,jdbcType=VARCHAR}, #{preferentialPolicy,jdbcType=BIGINT}, #{pointsFactor,jdbcType=DECIMAL}, 
      #{scoreUsage,jdbcType=INTEGER}, #{memPriceUsed,jdbcType=BIGINT}, #{discountRate,jdbcType=DECIMAL}, 
      #{toSavePoints,jdbcType=BIGINT}, #{isPackageDisc,jdbcType=BIGINT}, #{isPromotionDisc,jdbcType=BIGINT}, 
      #{isOnlineDefault,jdbcType=BIT}, #{createBy,jdbcType=VARCHAR}, #{createAt,jdbcType=TIMESTAMP}, 
      #{lastUpdateBy,jdbcType=VARCHAR}, #{lastUpdateAt,jdbcType=TIMESTAMP}, #{isDeleted,jdbcType=BIT}, 
      #{version,jdbcType=BIGINT}, #{branchId,jdbcType=BIGINT}, #{allowRefund, jdbcType=BIT}, #{deposit, jdbcType=DECIMAL},
      #{autoUpgrade,jdbcType=BIT},#{currLevel,jdbcType=INTEGER},#{upgradeType,jdbcType=INTEGER},#{upgradeLimit,jdbcType=DECIMAL}
      )
  </insert>

  <update id="update" parameterType="map" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Fri Nov 04 15:05:01 CST 2016.
    -->
    update vip_type
    <set >
      <if test="tenantId != null" >
        tenant_id = #{tenantId,jdbcType=BIGINT},
      </if>
      <if test="typeCode != null" >
        type_code = #{typeCode,jdbcType=VARCHAR},
      </if>
      <if test="typeName != null" >
        type_name = #{typeName,jdbcType=VARCHAR},
      </if>
      <if test="preferentialPolicy != null" >
        preferential_policy = #{preferentialPolicy,jdbcType=BIGINT},
      </if>
      <if test="pointsFactor != null" >
        points_factor = #{pointsFactor,jdbcType=DECIMAL},
      </if>
      <if test="scoreUsage != null" >
        score_usage = #{scoreUsage,jdbcType=INTEGER},
      </if>
      <if test="memPriceUsed != null" >
        mem_price_used = #{memPriceUsed,jdbcType=BIGINT},
      </if>
      discount_rate = #{discountRate,jdbcType=DECIMAL},
      <if test="toSavePoints != null" >
        to_save_points = #{toSavePoints,jdbcType=BIGINT},
      </if>
      <if test="isPackageDisc != null" >
        is_package_disc = #{isPackageDisc,jdbcType=BIGINT},
      </if>
      <if test="isPromotionDisc != null" >
        is_promotion_disc = #{isPromotionDisc,jdbcType=BIGINT},
      </if>
      <if test="isOnlineDefault != null" >
        is_online_default = #{isOnlineDefault,jdbcType=BIT},
      </if>
      <if test="createBy != null" >
        create_by = #{createBy,jdbcType=VARCHAR},
      </if>
      <if test="createAt != null" >
        create_at = #{createAt,jdbcType=TIMESTAMP},
      </if>
      <if test="lastUpdateBy != null" >
        last_update_by = #{lastUpdateBy,jdbcType=VARCHAR},
      </if>
      <if test="lastUpdateAt != null" >
        last_update_at = #{lastUpdateAt,jdbcType=TIMESTAMP},
      </if>
      <if test="isDeleted != null" >
        is_deleted = #{isDeleted,jdbcType=BIT},
      </if>
      <if test="version != null" >
        version = #{version,jdbcType=BIGINT},
      </if>
      <if test="localId != null" >
        local_id = #{localId,jdbcType=BIGINT},
      </if>
      <if test="branchId != null" >
        branch_id = #{branchId,jdbcType=BIGINT},
      </if>
      <if test="allowRefund != null">
        allow_refund = #{allowRefund,jdbcType=BIT},
      </if>
      <if test="deposit != null">
        deposit = #{deposit, jdbcType=DECIMAL},
      </if>
      <if test="scoreType != null">
        score_type = #{scoreType, jdbcType=DECIMAL},
      </if>
      <if test="autoUpgrade != null">
        auto_upgrade = #{autoUpgrade, jdbcType=DECIMAL},
      </if>
      <if test="currLevel != null">
        curr_level = #{currLevel, jdbcType=DECIMAL},
      </if>
      <if test="upgradeType != null">
        upgrade_type = #{upgradeType, jdbcType=DECIMAL},
      </if>
      <if test="upgradeLimit != null">
        upgrade_limit = #{upgradeLimit, jdbcType=DECIMAL},
      </if>
    </set>
    where id = #{id,jdbcType=BIGINT}
  </update>

  <select id="vipTypeList" parameterType="map" resultType="erp.chain.domain.o2o.VipType">
    SELECT * FROM vip_type vt WHERE is_deleted=0
    <if test="id != null and id != ''">
      AND vt.id =#{id}
    </if>
    <if test="tenantId != null and tenantId != ''">
      AND vt.tenant_id =${tenantId}
    </if>
    <if test="branchId != null and branchId != ''">
      AND vt.branch_id =#{branchId}
    </if>
    <if test="autoUpgrade != null and branchId != ''">
      AND vt.auto_upgrade =#{autoUpgrade}
    </if>
    <if test="currLevel != null and branchId != ''">
      AND vt.curr_level =#{currLevel}
    </if>
    <if test="queryStr != null and queryStr != ''">
      AND (vt.type_code like '%${queryStr}%' OR vt.type_name like '%${queryStr}%')
    </if>
    <if test="offset != null and rows!= null" >
      LIMIT ${offset},${rows}
    </if>
  </select>

  <select id="vipTypeListAuto" parameterType="map" resultType="erp.chain.domain.o2o.VipType">
    SELECT * FROM vip_type vt WHERE is_deleted=0
    <if test="id != null and id != ''">
      AND vt.id =#{id}
    </if>
    <if test="tenantId != null and tenantId != ''">
      AND vt.tenant_id =${tenantId}
    </if>
    <if test="branchId != null and branchId != ''">
      AND vt.branch_id =#{branchId}
    </if>
    <if test="autoUpgrade != null and branchId != ''">
      AND vt.auto_upgrade =#{autoUpgrade}
    </if>
    <if test="queryStr != null and queryStr != ''">
      AND (vt.type_code like '%${queryStr}%' OR vt.type_name like '%${queryStr}%')
    </if>
    <if test="tenantId != null and tenantId != ''">
      ORDER BY curr_level
    </if>
  </select>
  <select id="findByCondition" resultType="erp.chain.domain.o2o.VipType">
    SELECT * FROM vip_type WHERE is_deleted=0
    <if test="tenantId != null and tenantId != ''">
      AND tenant_id =${tenantId}
    </if>
    <if test="branchId != null and branchId != ''">
      AND branch_id =#{branchId}
    </if>
    <if test="id != null and id != ''">
      AND id =#{id}
    </if>
    <if test="typeName != null and typeName != ''">
      AND type_name =#{typeName}
    </if>
    <if test="isOnlineDefault != null and isOnlineDefault != ''">
      AND is_online_default =#{isOnlineDefault}
    </if>
    limit 1
  </select>
  <select id="queryIntegralRule" resultType="erp.chain.domain.o2o.VipType">
    SELECT * FROM vip_type WHERE is_deleted=0 and is_online_default=1
    <if test="tenantId != null and tenantId != ''">
      AND tenant_id =${tenantId}
    </if>
  </select>
  <select id="queryIntegralRuleByBranch" resultType="erp.chain.domain.o2o.VipType">
    SELECT * FROM vip_type WHERE is_deleted=0 and is_online_default=1
    <if test="tenantId != null and tenantId != ''">
      AND tenant_id =${tenantId}
    </if>
    <if test="branchId != null and branchId != ''">
      AND branch_id =#{branchId}
    </if>
  </select>
  <select id="findByTenantIdAndTypeName" resultType="erp.chain.domain.o2o.VipType">
    SELECT * FROM vip_type WHERE is_deleted=0
    <if test="tenantId != null and tenantId != ''">
      AND tenant_id =${tenantId}
    </if>
    <if test="typeName != null and typeName != ''">
      AND type_name =#{typeName}
    </if>
  </select>
<select id="getVipTypeCode" resultType="erp.chain.domain.o2o.VipType" >
  select * from vip_type v where v.tenant_id = ${tId} order By v.type_code
</select>

  <insert id="insertVipSpecialPromotion" parameterType="erp.chain.domain.o2o.VipSpecialPromotion" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Fri Nov 04 15:05:01 CST 2016.
    -->
    insert into vip_special_promotion (id, tenant_id,
    create_by, create_at,
    last_update_by, last_update_at, is_deleted,
    branch_id,add_score,promotion_type,
    prize_diet_promotion_ids,prize_diet_promotion_names,
    is_double_score_birthday,vip_day_times_score,weeks_setting,days_setting
    )
    values (#{id,jdbcType=BIGINT}, #{tenantId,jdbcType=BIGINT},
    #{createBy,jdbcType=VARCHAR}, #{createAt,jdbcType=TIMESTAMP},
    #{lastUpdateBy,jdbcType=VARCHAR}, #{lastUpdateAt,jdbcType=TIMESTAMP}, #{isDeleted,jdbcType=BIT},
    #{branchId,jdbcType=BIGINT},#{addScore,jdbcType=DECIMAL},#{promotionType,jdbcType=BIGINT},
    #{prizeDietPromotionIds,jdbcType=VARCHAR},#{prizeDietPromotionNames,jdbcType=VARCHAR},
    #{isDoubleScoreBirthday,jdbcType=INTEGER},#{vipDayTimesScore,jdbcType=INTEGER},#{weeksSetting,jdbcType=VARCHAR},#{daysSetting,jdbcType=VARCHAR}
    )
  </insert>

  <update id="updateVipSpecialPromotion" parameterType="map" >
    update vip_special_promotion
    <set >
      <if test="tenantId != null" >
        tenant_id = #{tenantId,jdbcType=BIGINT},
      </if>
      <if test="createBy != null" >
        create_by = #{createBy,jdbcType=VARCHAR},
      </if>
      <if test="prizeDietPromotionIds != null" >
        prize_diet_promotion_ids = #{prizeDietPromotionIds,jdbcType=VARCHAR},
      </if>
      <if test="prizeDietPromotionNames != null" >
        prize_diet_promotion_names = #{prizeDietPromotionNames,jdbcType=VARCHAR},
      </if>
      <if test="createAt != null" >
        create_at = #{createAt,jdbcType=TIMESTAMP},
      </if>
      <if test="lastUpdateBy != null" >
        last_update_by = #{lastUpdateBy,jdbcType=VARCHAR},
      </if>
      <if test="lastUpdateAt != null" >
        last_update_at = #{lastUpdateAt,jdbcType=TIMESTAMP},
      </if>
      <if test="isDeleted != null" >
        is_deleted = #{isDeleted,jdbcType=BIT},
      </if>
      <if test="isDoubleScoreBirthday != null" >
        is_double_score_birthday = #{isDoubleScoreBirthday,jdbcType=INTEGER},
      </if>
      <if test="branchId != null" >
        branch_id = #{branchId,jdbcType=BIGINT},
      </if>
      <if test="addScore != null">
        add_score = #{addScore, jdbcType=DECIMAL},
      </if>
      <if test="vipDayTimesScore != null">
        vip_day_times_score = #{vipDayTimesScore, jdbcType=INTEGER},
      </if>
      <if test="promotionType != null">
          promotion_type = #{promotionType, jdbcType=BIGINT},
      </if>
      <if test="weeksSetting != null">
          weeks_setting = #{weeksSetting, jdbcType=VARCHAR},days_setting = NULL,
      </if>
      <if test="daysSetting != null">
          days_setting = #{daysSetting, jdbcType=INTEGER},weeks_setting = NULL,
      </if>
      <if test="clear != null and clear == 1">
          days_setting = NULL,weeks_setting = NULL,
      </if>
    </set>
    where id = #{id,jdbcType=BIGINT}
  </update>
  <select id="findSpecialPromotionByTenantIdAndType" resultType="erp.chain.domain.o2o.VipSpecialPromotion">
    SELECT * FROM vip_special_promotion WHERE is_deleted=0
    <if test="tenantId != null and tenantId != ''">
      AND tenant_id =${tenantId}
    </if>
    <if test="branchId != null and branchId != ''">
      AND branch_id =${branchId}
    </if>
    <if test="promotionType != null and promotionType != ''">
        <if test="promotionType == 3 or promotionType == 4">
            AND (promotion_type = 3 OR promotion_type = 4)
        </if>
        <if test="promotionType != 3 and promotionType != 4">
            AND promotion_type =#{promotionType}
        </if>
    </if>
    limit 1
  </select>

  <select id="findSpecialPromotion" resultType="mapUnderscoreToCamelCase">
    SELECT vsp.*,dpf.card_id FROM vip_special_promotion vsp
    LEFT JOIN diet_promotion_festival dpf ON vsp.tenant_id=dpf.tenant_id AND vsp.prize_diet_promotion_ids=dpf.id AND dpf.is_deleted=0
    WHERE vsp.is_deleted=0
    <if test="tenantId != null and tenantId != ''">
      AND vsp.tenant_id =${tenantId}
    </if>
    <if test="branchId != null and branchId != ''">
      AND vsp.branch_id =${branchId}
    </if>
    <if test="promotionType != null and promotionType != ''">
        <if test="promotionType == 3 or promotionType == 4">
            AND (vsp.promotion_type = 3 OR vsp.promotion_type = 4)
        </if>
        <if test="promotionType != 3 and promotionType !=4">
            AND vsp.promotion_type =#{promotionType}
        </if>
    </if>
    limit 1
  </select>


  <select id="findSpecialPromotions" resultType="erp.chain.domain.o2o.VipSpecialPromotion">
    SELECT * FROM vip_special_promotion WHERE is_deleted=0
    <if test="tenantId != null and tenantId != ''">
      AND tenant_id =${tenantId}
    </if>
    <if test="branchId != null and branchId != ''">
      AND branch_id =#{branchId}
    </if>
    <if test="promotionType != null and promotionType != ''">
      AND promotion_type =#{promotionType}
    </if>
  </select>

  <select id="getWechatVipType" resultType="erp.chain.domain.o2o.VipType">
    SELECT * FROM vip_type WHERE is_deleted=0
    <if test="tenantId != null and tenantId != ''">
      AND tenant_id =${tenantId}
    </if>
    <if test="branchId != null and branchId != ''">
      AND branch_id =#{branchId}
    </if>
    <if test="isOnline != null and isOnline != ''">
      AND is_online_default = 1
    </if>
    limit 1
  </select>

  <select id="findTypeById" resultType="erp.chain.domain.o2o.VipType">
    SELECT * FROM vip_type WHERE tenant_id=${tenantId} AND is_deleted=0 AND id=${id}
  </select>

  <insert id="setBranchDiscount" parameterType="map" useGeneratedKeys="true" keyProperty="id">
      INSERT INTO branch_discount (tenant_id, branch_id, type_id, discount_rate, emp_id, create_at, create_by, last_update_at, last_update_by, is_deleted)
      VALUES (#{tenantId,jdbcType=BIGINT}, #{branchId,jdbcType=BIGINT}, #{typeId,jdbcType=BIGINT}, #{discountRate,jdbcType=DECIMAL}, #{empId,jdbcType=BIGINT},
      #{createAt,jdbcType=TIMESTAMP}, #{createBy,jdbcType=VARCHAR}, #{lastUpdateAt,jdbcType=TIMESTAMP}, #{lastUpdateBy,jdbcType=VARCHAR}, #{isDeleted,jdbcType=BIT})
  </insert>

  <update id="updateBranchDiscount" parameterType="map">
      UPDATE branch_discount
      <set>
          <if test="branchId != null and branchId != ''">
              branch_id = #{branchId,jdbcType=BIGINT},
          </if>
          <if test="discountRate != null and discountRate != ''">
              discount_rate = #{discountRate,jdbcType=DECIMAL},
          </if>
          <if test="empId != null and empId != ''">
              emp_id = #{empId,jdbcType=BIGINT},
          </if>
          <if test="isDeleted != null and isDeleted != ''">
              is_deleted = #{isDeleted,jdbcType=BIT},
          </if>
          <if test="lastUpdateAt != null">
              last_update_at = #{lastUpdateAt,jdbcType=TIMESTAMP},
          </if>
      </set>
      WHERE tenant_id = #{tenantId} AND id = #{id}
  </update>

  <select id="findBranchDiscount" resultType="erp.chain.domain.o2o.BranchDiscount">
      SELECT * FROM branch_discount WHERE tenant_id = #{tenantId} AND branch_id = #{branchId} AND id = #{id} AND is_deleted = 0
  </select>

    <select id="findBranchDiscountByTypeId" resultType="erp.chain.domain.o2o.BranchDiscount">
        SELECT * FROM branch_discount WHERE tenant_id = #{tenantId} AND branch_id = #{branchId} AND type_id = #{typeId} AND is_deleted = 0
    </select>


    <update id="deleteBranchDiscountByType" parameterType="map">
        UPDATE branch_discount SET is_deleted = 1
        WHERE tenant_id = #{tenantId} AND type_id = #{typeId}
    </update>
</mapper>