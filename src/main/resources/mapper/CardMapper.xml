<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="erp.chain.mapper.CardMapper" >

  <resultMap id="BaseResultMap" type="erp.chain.domain.Card" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Tue Nov 15 13:50:48 CST 2016.
    -->
    <id column="id" property="id" jdbcType="BIGINT" />
    <result column="code" property="code" jdbcType="VARCHAR" />
    <result column="type" property="type" jdbcType="TINYINT" />
    <result column="state" property="state" jdbcType="TINYINT" />
    <result column="secret_key" property="secretKey" jdbcType="VARCHAR" />
    <result column="tenant_id" property="tenantId" jdbcType="BIGINT" />
    <result column="tenant_code" property="tenantCode" jdbcType="VARCHAR" />
    <result column="branch_code" property="branchCode" jdbcType="VARCHAR" />
    <result column="auth_card_id" property="authCardId" jdbcType="BIGINT" />
    <result column="holder_id" property="holderId" jdbcType="BIGINT" />
    <result column="create_at" property="createAt" jdbcType="TIMESTAMP" />
    <result column="create_by" property="createBy" jdbcType="VARCHAR" />
    <result column="last_update_at" property="lastUpdateAt" jdbcType="TIMESTAMP" />
    <result column="last_update_by" property="lastUpdateBy" jdbcType="VARCHAR" />
    <result column="is_deleted" property="isDeleted" jdbcType="BIT" />
  </resultMap>

  <insert id="insert" parameterType="map" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Tue Nov 15 13:50:48 CST 2016.
    -->
    insert into card (id, code, type,
    state, secret_key, tenant_id,
    tenant_code, branch_code, auth_card_id,
    holder_id, create_at, create_by,
    last_update_at, last_update_by, is_deleted, branch_id
    )
    values (#{id,jdbcType=BIGINT}, #{code,jdbcType=VARCHAR}, #{type,jdbcType=TINYINT},
    #{state,jdbcType=TINYINT}, #{secretKey,jdbcType=VARCHAR}, #{tenantId,jdbcType=BIGINT},
    #{tenantCode,jdbcType=VARCHAR}, #{branchCode,jdbcType=VARCHAR}, #{authCardId,jdbcType=BIGINT},
    #{holderId,jdbcType=BIGINT}, #{createAt,jdbcType=TIMESTAMP}, #{createBy,jdbcType=VARCHAR},
    #{lastUpdateAt,jdbcType=TIMESTAMP}, #{lastUpdateBy,jdbcType=VARCHAR}, #{isDeleted,jdbcType=BIT},#{branchId,jdbcType=BIGINT}
    )
  </insert>

  <insert id="insertCard" parameterType="erp.chain.domain.Card" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Tue Nov 15 13:50:48 CST 2016.
    -->
    insert into card (id, code, type,
    state, secret_key, tenant_id,
    tenant_code, branch_code, auth_card_id,
    holder_id, create_at, create_by,
    last_update_at, last_update_by, is_deleted, branch_id, card_face_num
    )
    values (#{id,jdbcType=BIGINT}, #{code,jdbcType=VARCHAR}, #{type,jdbcType=TINYINT},
    #{state,jdbcType=TINYINT}, #{secretKey,jdbcType=VARCHAR}, #{tenantId,jdbcType=BIGINT},
    #{tenantCode,jdbcType=VARCHAR}, #{branchCode,jdbcType=VARCHAR}, #{authCardId,jdbcType=BIGINT},
    #{holderId,jdbcType=BIGINT}, #{createAt,jdbcType=TIMESTAMP}, #{createBy,jdbcType=VARCHAR},
    #{lastUpdateAt,jdbcType=TIMESTAMP}, #{lastUpdateBy,jdbcType=VARCHAR}, #{isDeleted,jdbcType=BIT},
    #{branchId,jdbcType=BIGINT}, #{cardFaceNum,jdbcType=VARCHAR}
    )
  </insert>

  <update id="update" parameterType="map" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Tue Nov 15 13:50:48 CST 2016.
    -->
    update card
    <set >
      <if test="code != null" >
        code = #{code,jdbcType=VARCHAR},
      </if>
      <if test="type != null" >
        type = #{type,jdbcType=TINYINT},
      </if>
      <if test="state != null" >
        state = #{state,jdbcType=TINYINT},
      </if>
      <if test="secretKey != null" >
        secret_key = #{secretKey,jdbcType=VARCHAR},
      </if>
      <if test="tenantId != null" >
        tenant_id = #{tenantId,jdbcType=BIGINT},
      </if>
      <if test="tenantCode != null" >
        tenant_code = #{tenantCode,jdbcType=VARCHAR},
      </if>
      <if test="branchCode != null" >
        branch_code = #{branchCode,jdbcType=VARCHAR},
      </if>
      <if test="authCardId != null" >
        auth_card_id = #{authCardId,jdbcType=BIGINT},
      </if>
      <if test="holderId != null" >
        holder_id = #{holderId,jdbcType=BIGINT},
      </if>
      <if test="createAt != null" >
        create_at = #{createAt,jdbcType=TIMESTAMP},
      </if>
      <if test="createBy != null" >
        create_by = #{createBy,jdbcType=VARCHAR},
      </if>
      <if test="lastUpdateAt != null" >
        last_update_at = #{lastUpdateAt,jdbcType=TIMESTAMP},
      </if>
      <if test="lastUpdateBy != null" >
        last_update_by = #{lastUpdateBy,jdbcType=VARCHAR},
      </if>
      <if test="isDeleted != null" >
        is_deleted = #{isDeleted,jdbcType=BIT},
      </if>
      <if test="cardFaceNum != null" >
        card_face_num = #{cardFaceNum,jdbcType=VARCHAR},
      </if>
    </set>
    where id = #{id,jdbcType=BIGINT}
  </update>

    <update id="updateCard" parameterType="erp.chain.domain.Card">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Tue Nov 15 13:50:48 CST 2016.
        -->
        update card
        <set>
            <if test="code != null">
                code = #{code,jdbcType=VARCHAR},
            </if>
            <if test="type != null">
                type = #{type,jdbcType=TINYINT},
            </if>
            <if test="state != null">
                state = #{state,jdbcType=TINYINT},
            </if>
            <if test="secretKey != null">
                secret_key = #{secretKey,jdbcType=VARCHAR},
            </if>
            <if test="tenantId != null">
                tenant_id = #{tenantId,jdbcType=BIGINT},
            </if>
            <if test="tenantCode != null">
                tenant_code = #{tenantCode,jdbcType=VARCHAR},
            </if>
            <if test="branchCode != null">
                branch_code = #{branchCode,jdbcType=VARCHAR},
            </if>
            <if test="authCardId != null">
                auth_card_id = #{authCardId,jdbcType=BIGINT},
            </if>
            <if test="holderId != null">
                holder_id = #{holderId,jdbcType=BIGINT},
            </if>
            <if test="createAt != null">
                create_at = #{createAt,jdbcType=TIMESTAMP},
            </if>
            <if test="createBy != null">
                create_by = #{createBy,jdbcType=VARCHAR},
            </if>
            <if test="lastUpdateAt != null">
                last_update_at = #{lastUpdateAt,jdbcType=TIMESTAMP},
            </if>
            <if test="lastUpdateBy != null">
                last_update_by = #{lastUpdateBy,jdbcType=VARCHAR},
            </if>
            <if test="isDeleted != null">
                is_deleted = #{isDeleted,jdbcType=BIT},
            </if>
            <if test="cardFaceNum != null">
                card_face_num = #{cardFaceNum,jdbcType=VARCHAR},
            </if>
        </set>
        where id = #{id,jdbcType=BIGINT}
    </update>

  <select id="select" parameterType="map" resultType="erp.chain.domain.Card" >
    select * from card
    <where>
      is_deleted = false
      <if test="code != null">
        AND (code = #{code} OR card_face_num = #{code})
      </if>
      <if test="tenantId != null">
        AND tenant_id = #{tenantId}
      </if>
      <if test="type != null">
        AND type = #{type}
      </if>
      <if test="tenantCode != null">
        AND tenant_code = #{tenantCode}
      </if>
      <if test="holderId != null">
        AND holder_id = #{holderId}
      </if>
    </where>
  </select>
  <select id="findCardByCode" parameterType="map" resultType="erp.chain.domain.Card" >
    select * from card
    <where>
      is_deleted = false
      <if test="code != null">
        AND code = #{code}
      </if>
      <if test="tenantId != null">
        AND tenant_id = #{tenantId}
      </if>
      <if test="type != null">
        AND type = #{type}
      </if>
      <if test="tenantCode != null">
        AND tenant_code = #{tenantCode}
      </if>
      <if test="holderId != null">
        AND holder_id = #{holderId}
      </if>
    </where>
  </select>

  <select id="select1" parameterType="map" resultType="erp.chain.domain.Card" >
    select cd.* from card cd left join vip v on v.id = cd.holder_id
    <where>
      cd.is_deleted = false
      <if test="code != null">
        AND (cd.code = #{code} OR cd.card_face_num = #{code})
      </if>
      <if test="tenantId != null">
        AND cd.tenant_id = #{tenantId}
      </if>
      <if test="branchId != null">
        AND v.branch_id = #{branchId}
      </if>
      <if test="type != null">
        AND cd.type = #{type}
      </if>
      <if test="tenantCode != null">
        AND cd.tenant_code = #{tenantCode}
      </if>
      <if test="holderId != null">
        AND cd.holder_id = #{holderId}
      </if>
      <if test="groups != null">
        AND v.branch_id in (${groups})
      </if>
    </where>
  </select>

  <select id="findByCodeAndTenantId" parameterType="map" resultType="erp.chain.domain.Card" >
    select * from card where is_deleted = 0 and code = #{code} and tenant_id = #{tenantId}
  </select>

  <insert id="insertCardBook" parameterType="erp.chain.domain.CardBook" useGeneratedKeys="true" keyProperty="id">
    insert into card_book (id,tenant_id,branch_id,
    card_type,operate_type,pay_type,
    vip_store,pay_amount,gift_amount,
    deposit,vip_store_after,remark,
    holder_id, create_at, create_by,
    last_update_at, last_update_by, is_deleted,
    input_amount,tm_remain_times,card_code,type_id,change_times
    )
    values (#{id,jdbcType=BIGINT},#{tenantId,jdbcType=BIGINT},#{branchId,jdbcType=BIGINT},
    #{cardType,jdbcType=VARCHAR},#{operateType,jdbcType=VARCHAR},#{payType,jdbcType=VARCHAR},
    #{vipStore,jdbcType=DECIMAL},#{payAmount,jdbcType=DECIMAL},#{giftAmount,jdbcType=DECIMAL},
    #{deposit,jdbcType=DECIMAL},#{vipStoreAfter,jdbcType=DECIMAL}, #{remark,jdbcType=VARCHAR},
    #{holderId,jdbcType=BIGINT}, #{createAt,jdbcType=TIMESTAMP}, #{createBy,jdbcType=VARCHAR},
    #{lastUpdateAt,jdbcType=TIMESTAMP}, #{lastUpdateBy,jdbcType=VARCHAR}, #{isDeleted,jdbcType=BIT},
    #{inputAmount,jdbcType=DECIMAL},#{tmRemainTimes,jdbcType=BIGINT},#{cardCode,jdbcType=VARCHAR},
    #{typeId,jdbcType=BIGINT},#{changeTimes,jdbcType=BIGINT}
    )
  </insert>

  <insert id="insertCardType" parameterType="erp.chain.domain.CardType" useGeneratedKeys="true" keyProperty="id">
    insert into card_type (id,tenant_id,branch_id,
    type_name,card_kind,deposit,type_code,
    gift_limit,gift_amount,gift_times,
    allow_refund,start_time,end_time,
    create_at, create_by,last_update_at,
    last_update_by, is_deleted,
    tm_goods_id,tm_goods_name,tm_total_times,
    tm_price,tm_interval_type,tm_interval,denomination,use_rule_day,use_rule_time
    )
    values (#{id,jdbcType=BIGINT},#{tenantId,jdbcType=BIGINT},#{branchId,jdbcType=BIGINT},
    #{typeName,jdbcType=VARCHAR},#{cardKind,jdbcType=TINYINT},#{deposit,jdbcType=DECIMAL},#{typeCode,jdbcType=VARCHAR},
    #{giftLimit,jdbcType=DECIMAL},#{giftAmount,jdbcType=DECIMAL},#{giftTimes,jdbcType=BIGINT},
    #{allowRefund,jdbcType=BIT},#{startTime,jdbcType=TIMESTAMP}, #{endTime,jdbcType=TIMESTAMP},
    #{createAt,jdbcType=TIMESTAMP}, #{createBy,jdbcType=VARCHAR},#{lastUpdateAt,jdbcType=TIMESTAMP},
    #{lastUpdateBy,jdbcType=VARCHAR}, #{isDeleted,jdbcType=BIT},
    #{tmGoodsId,jdbcType=BIGINT},#{tmGoodsName,jdbcType=VARCHAR},#{tmTotalTimes,jdbcType=BIGINT},
    #{tmPrice,jdbcType=DECIMAL},#{tmIntervalType,jdbcType=TINYINT},#{tmInterval,jdbcType=BIGINT},#{denomination,jdbcType=DECIMAL},
    #{useRuleDay,jdbcType=TINYINT},#{useRuleTime,jdbcType=TINYINT}
    )
  </insert>

  <update id="updateCardType" parameterType="erp.chain.domain.CardType" >
    update card_type
    <set >
      <if test="typeName != null" >
        type_name = #{typeName,jdbcType=VARCHAR},
      </if>
      <if test="deposit != null" >
        deposit = #{deposit,jdbcType=DECIMAL},
      </if>
      <if test="giftLimit != null" >
        gift_limit = #{giftLimit,jdbcType=DECIMAL},
      </if>
      <if test="giftAmount != null" >
        gift_amount = #{giftAmount,jdbcType=DECIMAL},
      </if>
      <if test="allowRefund != null" >
        allow_refund = #{allowRefund,jdbcType=BIT},
      </if>
      <if test="tmGoodsId != null" >
        tm_goods_id = #{tmGoodsId,jdbcType=DECIMAL},
      </if>
      <if test="tmGoodsName != null" >
        tm_goods_name = #{tmGoodsName,jdbcType=DECIMAL},
      </if>
      <if test="tmTotalTimes != null" >
        tm_total_times = #{tmTotalTimes,jdbcType=DECIMAL},
      </if>
      <if test="tmPrice != null" >
        tm_price = #{tmPrice,jdbcType=DECIMAL},
      </if>
      <if test="tmIntervalType != null" >
        tm_interval_type = #{tmIntervalType,jdbcType=DECIMAL},
      </if>
      tm_interval = #{tmInterval,jdbcType=DECIMAL},
      <if test="startTime == null" >
        start_time = NULL ,
      </if>
      <if test="endTime == null" >
        end_time = NULL,
      </if>
      <if test="startTime != null" >
        start_time = #{startTime,jdbcType=TIMESTAMP},
      </if>
      <if test="endTime != null" >
        end_time = #{endTime,jdbcType=TIMESTAMP},
      </if>
      <if test="lastUpdateAt != null" >
        last_update_at = #{lastUpdateAt,jdbcType=TIMESTAMP},
      </if>
      <if test="lastUpdateBy != null" >
        last_update_by = #{lastUpdateBy,jdbcType=VARCHAR},
      </if>
      <if test="isDeleted != null" >
        is_deleted = #{isDeleted,jdbcType=BIT},
      </if>
      <if test="denomination != null">
        denomination = #{denomination,jdbcType=DECIMAL},
      </if>
        use_rule_day = #{useRuleDay,jdbcType=TINYINT},
        use_rule_time = #{useRuleTime,jdbcType=TINYINT},
    </set>
    where id = #{id,jdbcType=BIGINT}
  </update>

  <update id="updateCardAccount" parameterType="erp.chain.domain.CardAccount" >
    update card_account
    <set >
      <if test="vipStore != null" >
        vip_store = #{vipStore,jdbcType=VARCHAR},
      </if>
      <if test="vipStoreTotal != null" >
        vip_store_total = #{vipStoreTotal,jdbcType=DECIMAL},
      </if>
      <if test="memo != null" >
        memo = #{memo,jdbcType=DECIMAL},
      </if>
      <if test="vipGiftTotal != null" >
        vip_gift_total = #{vipGiftTotal,jdbcType=DECIMAL},
      </if>
      <if test="status != null" >
        status = #{status,jdbcType=BIT},
      </if>
      <if test="buyTimes != null" >
        buy_times = #{buyTimes,jdbcType=TIMESTAMP},
      </if>
      <if test="sumConsume != null" >
        sum_consume = #{sumConsume,jdbcType=TIMESTAMP},
      </if>
      <if test="lastUpdateAt != null" >
        last_update_at = #{lastUpdateAt,jdbcType=TIMESTAMP},
      </if>
      <if test="tmRemainTimes != null" >
        tm_remain_times = #{tmRemainTimes,jdbcType=BIGINT},
      </if>
    </set>
    where id = #{id,jdbcType=BIGINT}
  </update>


  <select id="listCardTypes" parameterType="map" resultType="erp.chain.domain.CardType" >
    select * from card_type
    <where>
      is_deleted = false
      <if test="id != null and id != ''">
        AND id = #{id}
      </if>
      <if test="branchId != null and branchId != ''">
        AND branch_id = #{branchId}
      </if>
      <if test="tenantId != null and tenantId != ''">
        AND tenant_id = #{tenantId}
      </if>
      <if test="cardKind != null and cardKind != ''">
        AND card_kind IN (${cardKind})
      </if>
      <if test="typeCode != null and typeCode != ''">
        AND type_code = #{typeCode}
      </if>
      <if test="queryStr != null and queryStr != ''">
        AND (type_code like '%${queryStr}%' OR type_name like '%${queryStr}%')
      </if>
      <if test="startTime != null and startTime != ''">
        AND start_time >= #{startTime}
      </if>
      <if test="endTime != null and endTime != ''">
        <![CDATA[
          AND end_time <= #{endTime}
        ]]>
      </if>
      <if test="offset != null and rows!= null" >
        LIMIT ${offset},${rows}
      </if>
    </where>
  </select>

  <select id="listCardTypesVo" parameterType="map" resultType="erp.chain.domain.o2o.vo.CardTypeVo" >
    select * from card_type
    <where>
      is_deleted = false
      <if test="id != null and id != ''">
        AND id = #{id}
      </if>
      <if test="branchId != null and branchId != ''">
        AND branch_id = #{branchId}
      </if>
      <if test="tenantId != null and tenantId != ''">
        AND tenant_id = #{tenantId}
      </if>
      <if test="cardKind != null and cardKind != ''">
        AND card_kind = #{cardKind}
      </if>
      <if test="typeName != null and typeName != ''">
        AND type_name like '%${typeName}%'
      </if>
      <if test="typeCode != null and typeCode != ''">
        AND type_code = #{typeCode}
      </if>
      <if test="offset != null and rows!= null" >
        LIMIT ${offset},${rows}
      </if>
    </where>
  </select>

  <select id="findCardTypeById" parameterType="map" resultType="erp.chain.domain.CardType" >
    select * from card_type WHERE is_deleted = 0 and id = ${id} and tenant_id = ${tenantId}
  </select>

  <insert id="insertCardAccount" parameterType="erp.chain.domain.CardAccount" useGeneratedKeys="true" keyProperty="id">
    insert into card_account (id,tenant_id,branch_id,
    type_id,card_id,vip_id,
    card_code,vip_name,vip_store,
    vip_store_total,vip_gift_total,phone,
    memo,status,buy_times,sum_consume,
    create_at, create_by,last_update_at,
    last_update_by, is_deleted,
    tm_goods_id,tm_goods_name,tm_remain_times,
    tm_price,tm_interval_type,tm_interval,
    card_kind,start_time,end_time,tm_total_times,
    type_name
    )
    values (#{id,jdbcType=BIGINT},#{tenantId,jdbcType=BIGINT},#{branchId,jdbcType=BIGINT},
    #{typeId,jdbcType=BIGINT},#{cardId,jdbcType=BIGINT},#{vipId,jdbcType=BIGINT},
    #{cardCode,jdbcType=VARCHAR},#{vipName,jdbcType=VARCHAR},#{vipStore,jdbcType=DECIMAL},
    #{vipStoreTotal,jdbcType=DECIMAL},#{vipGiftTotal,jdbcType=DECIMAL},#{phone,jdbcType=VARCHAR},
    #{memo,jdbcType=VARCHAR},#{status,jdbcType=TINYINT}, #{buyTimes,jdbcType=BIGINT},#{sumConsume,jdbcType=DECIMAL},
    #{createAt,jdbcType=TIMESTAMP},#{createBy,jdbcType=VARCHAR},#{lastUpdateAt,jdbcType=TIMESTAMP},
    #{lastUpdateBy,jdbcType=VARCHAR},#{isDeleted,jdbcType=BIT},
    #{tmGoodsId,jdbcType=BIGINT},#{tmGoodsName,jdbcType=VARCHAR},#{tmRemainTimes,jdbcType=BIGINT},
    #{tmPrice,jdbcType=DECIMAL},#{tmIntervalType,jdbcType=TINYINT},#{tmInterval,jdbcType=BIGINT},
    #{cardKind,jdbcType=TINYINT},#{startTime,jdbcType=TIMESTAMP}, #{endTime,jdbcType=TIMESTAMP},
    #{tmTotalTimes,jdbcType=BIGINT},#{typeName,jdbcType=VARCHAR}
    )
  </insert>

  <select id="listCardAccounts" parameterType="map" resultType="erp.chain.domain.CardAccount" >
    select * from card_account
    <where>
      is_deleted = false
      <if test="branchId != null and branchId != ''">
        AND branch_id = #{branchId}
      </if>
      <if test="tenantId != null and tenantId != ''">
        AND tenant_id = #{tenantId}
      </if>
      <if test="vipId != null and vipId != ''">
        AND vip_id = #{vipId}
      </if>
      <if test="cardKind != null and cardKind != ''">
        AND card_kind = #{cardKind}
      </if>
      <if test="typeId != null and typeId != ''">
        AND type_id = #{typeId}
      </if>
      <if test="cardId != null and cardId != ''">
        AND card_id = #{cardId}
      </if>
      <if test="cardCode != null and cardCode != ''">
        AND card_code = #{cardCode}
      </if>
      <if test="startTime != null and startTime != ''">
        AND create_at >= #{startTime}
      </if>
      <if test="endTime != null and endTime != ''">
        AND #{endTime} >= create_at
      </if>
      <if test="phone != null and phone != ''">
        AND phone = #{phone}
      </if>
      <if test="status != null and status != ''">
        AND status = #{status}
      </if>

      <if test="offset != null and rows!= null" >
        LIMIT ${offset},${rows}
      </if>
    </where>
  </select>
  <select id="listCardAccountsForBalance" parameterType="map" resultType="erp.chain.domain.o2o.vo.CardAccountVo" >
    select ca.*,v.vip_name,ct.type_name,g.goods_code from card_account ca LEFT JOIN vip v ON ca.vip_id = v.id LEFT JOIN goods g on g.id = ca.tm_goods_id
    LEFT JOIN card_type ct on ca.type_id = ct.id
    <where>
      is_deleted = false
      <if test="branchId != null and branchId != ''">
        AND ca.branch_id = #{branchId}
      </if>
      <if test="tenantId != null and tenantId != ''">
        AND ca.tenant_id = #{tenantId}
      </if>
      <if test="vipId != null and vipId != ''">
        AND ca.vip_id = #{vipId}
      </if>
      <if test="cardKind != null and cardKind != ''">
        AND ca.card_kind = #{cardKind}
      </if>
      <if test="typeId != null and typeId != ''">
        AND ca.type_id = #{typeId}
      </if>
      <if test="cardId != null and cardId != ''">
        AND ca.card_id = #{cardId}
      </if>
      <if test="cardCode != null and cardCode != ''">
        AND ca.card_code = #{cardCode}
      </if>
      <if test="phone != null and phone != ''">
        AND ca.phone = #{phone}
      </if>
      <if test="status != null and status != ''">
        AND ca.status = #{status}
      </if>

      <if test="offset != null and rows!= null" >
        LIMIT ${offset},${rows}
      </if>
    </where>
  </select>

  <select id="findCardAccountById" parameterType="map" resultType="erp.chain.domain.CardAccount" >
    select * from card_account WHERE is_deleted = 0 and id = ${id} and tenant_id = ${tenantId}
  </select>

  <select id="listCardBook" parameterType="map" resultType="erp.chain.domain.CardBook" >
    select * from card_book
    <where>
      is_deleted = false
      <if test="branchId != null and branchId != ''">
        AND branch_id = #{branchId}
      </if>
      <if test="tenantId != null and tenantId != ''">
        AND tenant_id = #{tenantId}
      </if>
      <if test="holderId != null and holderId != ''">
        AND holder_id = #{holderId}
      </if>
      <if test="cardType != null and cardType != ''">
        AND card_type = #{cardType}
      </if>
      <if test="cardCode != null and cardType != ''">
        AND card_code = #{cardCode}
      </if>
      <if test="operateType != null and operateType != ''">
        AND operate_type = #{operateType}
      </if>
      <if test="payType != null and payType != ''">
        AND pay_type = #{payType}
      </if>
      <if test="startTime != null and startTime != ''">
        AND create_at &gt;= '${startTime}:00'
      </if>
      <if test="endTime != null and endTime != ''">
        AND create_at &lt;= '${endTime}:59'
      </if>
      <if test="offset != null and rows!= null" >
        LIMIT ${offset},${rows}
      </if>
    </where>
  </select>

  <select id="listCardBookVoSum" parameterType="map" resultType="mapUnderscoreToCamelCase">
    SELECT SUM(t.tm_total_times) tm_total_times, SUM(t.change_times) change_times, SUM(t.tm_remain_times) tm_remain_times FROM(
    SELECT
    b. NAME branch_name,
    g.goods_code,
    g.goods_name,
    v.phone,
    v.vip_code,
    v.vip_name,
    ct.tm_total_times,
    ct.type_name,
    ct.tm_goods_id,
    cb.*,
    c.code vip_card_code
    FROM
    card_book cb
    INNER JOIN vip v ON cb.holder_id = v.id
    AND cb.tenant_id = v.tenant_id
    LEFT JOIN card c ON c.holder_id=cb.holder_id
    AND c.tenant_id=cb.tenant_id
    AND c.is_deleted=0
    INNER JOIN card_type ct ON cb.type_id = ct.id
    AND ct.tenant_id = cb.tenant_id
    INNER JOIN goods g ON ct.tm_goods_id = g.id
    AND g.tenant_id = cb.tenant_id
    INNER JOIN branch b ON b.id = cb.branch_id
    AND b.tenant_id = cb.tenant_id
    <where>
      cb.is_deleted = false
      <if test="branchId != null and branchId != ''">
        AND cb.branch_id IN (${branchId})
      </if>
      <if test="tenantId != null and tenantId != ''">
        AND cb.tenant_id = #{tenantId}
      </if>
      <if test="holderId != null and holderId != ''">
        AND cb.holder_id = #{holderId}
      </if>
      <if test="startDate != null and startDate != ''">
        AND cb.create_at &gt;= #{startDate}
      </if>
      <if test="endDate != null and endDate != ''">
        AND cb.create_at &lt;= #{endDate}
      </if>
      <if test="operateType != null and operateType != ''">
        AND cb.operate_type = #{operateType}
      </if>
      <if test="cardType != null and cardType != ''">
        AND cb.card_type = #{cardType}
      </if>
      <if test="typeId != null and typeId != ''">
        AND cb.type_id = #{typeId}
      </if>
      <if test="typeName != null and typeName != ''">
        AND ct.type_name = #{typeName}
      </if>
      <if test="cardCode != null and cardType != ''">
        AND cb.card_code = #{cardCode}
      </if>
      <if test="vipCondition != null and vipCondition != ''">
        AND (c.code LIKE '%${vipCondition}%' OR v.vip_name LIKE '%${vipCondition}%' OR v.phone LIKE '%${vipCondition}%')
      </if>
      <if test="createBy != null and createBy != ''">
        AND cb.create_by LIKE '%${createBy}%'
      </if>
      <if test="vipName != null and vipName != ''">
        AND v.vip_name LIKE '%${vipName}%'
      </if>
      <if test="phone != null and phone != ''">
        AND v.phone LIKE '%${phone}%'
      </if>
      <if test="payType != null and payType != ''">
        AND cb.pay_type = #{payType}
      </if>
    </where>
    ) t
  </select>

  <select id="listCardBookVo" parameterType="map" resultType="mapUnderscoreToCamelCase" >
    SELECT
    b. NAME branch_name,
    g.goods_code,
    g.goods_name,
    v.phone,
    v.vip_code,
    v.vip_name,
    ct.tm_total_times,
    ct.type_name,
    ct.tm_goods_id,
    cb.*,
    c.code vip_card_code
    FROM
    card_book cb
    INNER JOIN vip v ON cb.holder_id = v.id AND cb.tenant_id = v.tenant_id
    LEFT JOIN card c ON c.holder_id=cb.holder_id AND c.tenant_id=cb.tenant_id AND c.is_deleted=0
    INNER JOIN card_type ct ON cb.type_id = ct.id AND ct.tenant_id = cb.tenant_id
    INNER JOIN goods g ON ct.tm_goods_id = g.id AND g.tenant_id = cb.tenant_id
    INNER JOIN branch b ON b.id = cb.branch_id
    AND b.tenant_id = cb.tenant_id
    <where>
      cb.is_deleted = false
      <if test="tenantId != null and tenantId != ''">
        AND cb.tenant_id = #{tenantId}
      </if>
      <if test="branchId != null and branchId != ''">
        AND cb.branch_id IN (${branchId})
      </if>
      <if test="parentId != null and parentId != ''">
        AND b.parent_id = #{parentId}
      </if>
      <if test="holderId != null and holderId != ''">
        AND cb.holder_id = #{holderId}
      </if>
      <if test="startDate != null and startDate != ''">
        AND cb.create_at &gt;= #{startDate}
      </if>
      <if test="endDate != null and endDate != ''">
        AND cb.create_at &lt;= #{endDate}
      </if>
      <if test="operateType != null and operateType != ''">
        AND cb.operate_type = #{operateType}
      </if>
      <if test="cardType != null and cardType != ''">
        AND cb.card_type = #{cardType}
      </if>
      <if test="typeId != null and typeId != ''">
        AND cb.type_id = #{typeId}
      </if>
      <if test="typeName != null and typeName != ''">
        AND ct.type_name = #{typeName}
      </if>
      <if test="cardCode != null and cardType != ''">
        AND cb.card_code = #{cardCode}
      </if>
      <if test="vipCondition != null and vipCondition != ''">
        AND (c.code LIKE '%${vipCondition}%' OR v.vip_name LIKE '%${vipCondition}%' OR v.phone LIKE '%${vipCondition}%')
      </if>
      <if test="createBy != null and createBy != ''">
        AND cb.create_by LIKE '%${createBy}%'
      </if>
      <if test="vipName != null and vipName != ''">
        AND v.vip_name LIKE '%${vipName}%'
      </if>
      <if test="phone != null and phone != ''">
        AND v.phone LIKE '%${phone}%'
      </if>
      <if test="payType != null and payType != ''">
        AND cb.pay_type = #{payType}
      </if>
      ORDER BY cb.create_at DESC
      <if test="offset != null and rows!= null" >
        LIMIT ${offset},${rows}
      </if>
    </where>
  </select>

  <insert id="insertWxCard" parameterType="erp.chain.domain.o2o.WxCard" useGeneratedKeys="true" keyProperty="id">
    insert into wx_card (id,tenant_id,branch_id,
    check_status,card_id,
    create_at, create_by,last_update_at,
    last_update_by, is_deleted,
    qr_code,pay_gift_card,rule_id,background_pic_url
    )
    values (#{id,jdbcType=BIGINT},#{tenantId,jdbcType=BIGINT},#{branchId,jdbcType=BIGINT},
    #{checkStatus,jdbcType=INTEGER},#{cardId,jdbcType=VARCHAR},
    #{createAt,jdbcType=TIMESTAMP},#{createBy,jdbcType=VARCHAR},#{lastUpdateAt,jdbcType=TIMESTAMP},
    #{lastUpdateBy,jdbcType=VARCHAR},#{isDeleted,jdbcType=BIT},
    #{qrCode,jdbcType=VARCHAR},#{payGiftCard,jdbcType=BIT},#{ruleId,jdbcType=VARCHAR},#{backgroundPicUrl,jdbcType=VARCHAR}
    )
  </insert>
  <update id="updateWxCard" parameterType="erp.chain.domain.o2o.WxCard" >
    update wx_card
    <set >
      <if test="ruleId != null" >
        rule_id = #{ruleId,jdbcType=VARCHAR},
      </if>
      <if test="checkStatus != null" >
        check_status = #{checkStatus,jdbcType=TIMESTAMP},
      </if>
      <if test="qrCode != null" >
        qr_code = #{qrCode,jdbcType=VARCHAR},
      </if>
      <if test="payGiftCard != null" >
        pay_gift_card = #{payGiftCard,jdbcType=TIMESTAMP},
      </if>
      <if test="backgroundPicUrl != null" >
        background_pic_url = #{backgroundPicUrl,jdbcType=TIMESTAMP}
      </if>
    </set>
    where card_id = #{cardId,jdbcType=VARCHAR}
  </update>
  <select id="findWxCard" parameterType="map" resultType="erp.chain.domain.o2o.WxCard" >
    select * from wx_card
    <where>
      is_deleted = false
      <if test="branchId != null and branchId != ''">
        AND branch_id = #{branchId}
      </if>
      <if test="tenantId != null and tenantId != ''">
        AND tenant_id = #{tenantId}
      </if>
      <if test="cardId != null and cardId != ''">
        AND card_id = #{cardId}
      </if>
    </where>
  </select>
    <!--查询次卡、面值卡是否被使用-->
    <select id="cardIsUsed" resultType="java.lang.Integer">
        SELECT count(1) FROM card_account WHERE tenant_id = #{tenantId} AND type_id = #{id} AND is_deleted = 0
        <if test="cardKind != null and cardKind == 3">
            AND tm_remain_times != 0
        </if>
        <if test="cardKind != null and cardKind == 2">
            AND vip_store != 0
        </if>
    </select>
    <!--查询次卡某一时间段内的使用次数-->
    <select id="queryUsedTimes" resultType="java.lang.Integer">
        SELECT count(1) FROM card_book WHERE tenant_id = #{tenantId} AND branch_id = #{branchId} AND is_deleted = 0 AND card_type = 7 AND operate_type = 5
        AND type_id = #{typeId} AND holder_id = #{holderId} AND create_at &gt;= #{startDate}
    </select>
</mapper>