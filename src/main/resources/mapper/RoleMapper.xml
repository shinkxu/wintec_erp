<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="erp.chain.mapper.RoleMapper">
    <insert id="insert" parameterType="Map" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO s_role(package_name,tenant_id,branch_id,role_code,role_name,create_by,
        create_at,last_update_by,last_update_at,is_deleted,role_type)
        VALUES (#{packageName},${tenantId},${branchId},#{roleCode},#{roleName},#{createBy},
        #{createAt},#{lastUpdateBy},#{lastUpdateAt},#{isDeleted},#{roleType})
    </insert>
    <update id="update" parameterType="map" >
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Fri Nov 04 15:05:01 CST 2016.
        -->
        update s_role
        <set >
            <if test="tenantId != null" >
                tenant_id = #{tenantId,jdbcType=BIGINT},
            </if>
            <if test="branchId != null" >
                branch_id = #{branchId,jdbcType=BIGINT},
            </if>
            <if test="createAt != null" >
                create_at = #{createAt,jdbcType=TIMESTAMP},
            </if>
            <if test="createBy != null" >
                create_by = #{createBy,jdbcType=VARCHAR},
            </if>
            <if test="lastUpdateAt != null" >
                last_update_at = #{lastUpdateAt,jdbcType=TIMESTAMP},
            </if>
            <if test="lastUpdateBy != null" >
                last_update_by = #{lastUpdateBy,jdbcType=VARCHAR},
            </if>
            <if test="isDeleted != null" >
                is_deleted = #{isDeleted,jdbcType=BIT},
            </if>
            <if test="packageName != null" >
                package_name = #{packageName,jdbcType=VARCHAR},
            </if>
            <if test="roleCode != null" >
                role_code = #{roleCode,jdbcType=VARCHAR},
            </if>
            <if test="roleName != null" >
                role_name = #{roleName,jdbcType=VARCHAR},
            </if>
            <if test="roleType != null" >
                role_type = #{roleType,jdbcType=TINYINT},
            </if>
        </set>
        where id = #{id,jdbcType=BIGINT}
    </update>





    <select id="queryRoleList" resultType="mapUnderscoreToCamelCase">
        SELECT * FROM s_role WHERE tenant_id=${tenantId} AND is_deleted=0
        <if test="codeOrName!=null and codeOrName!=''">
            AND (role_code LIKE '%${codeOrName}%' OR role_name LIKE '%${codeOrName}%')
        </if>
        <if test="order==null and field==null">
            ORDER BY id ASC
        </if>
        <if test="order!=null and field!=null">
            ORDER BY ${field} ${order}
        </if>
        <if test="rows!=null and offset!=null">
            LIMIT ${offset},${rows}
        </if>
    </select>
    <select id="queryRoleListSum" resultType="Long">
        SELECT count(1) FROM s_role WHERE tenant_id=${tenantId} AND is_deleted=0
        <if test="codeOrName!=null and codeOrName!=''">
            AND (role_code LIKE '%${codeOrName}%' OR role_name LIKE '%${codeOrName}%')
        </if>
    </select>
    <select id="getRoleCode" resultType="String">
        SELECT max(role_code) FROM s_role WHERE tenant_id=${tenantId} AND is_deleted=0
    </select>
    <select id="findRoleById" resultType="erp.chain.domain.SysRole">
        SELECT * FROM s_role WHERE id=#{id} AND is_deleted=0
        <if test="tenantId!=null">
            AND tenant_id=${tenantId}
        </if>
    </select>
    <select id="countUsedRole" resultType="Long">
        SELECT count(1) FROM s_user_role_r WHERE role_id=#{roleId}
    </select>

    <select id="getShopManager" resultType="erp.chain.domain.SysRole">
        SELECT * FROM s_role WHERE tenant_id=${tenantId} AND is_deleted=0 AND role_type=3
    </select>

    <select id="getStallsManager" resultType="erp.chain.domain.SysRole">
        SELECT * FROM s_role WHERE tenant_id=${tenantId} AND is_deleted=0 AND role_type=6
    </select>

    <insert id="insertRoleUser" >
        INSERT INTO s_user_role_r(user_id,role_id,tenant_id)VALUES (#{userId},#{roleId},#{tenantId})
    </insert>

    <select id="getManager" resultType="erp.chain.domain.SysRole">
        SELECT * FROM s_role WHERE tenant_id=${tenantId} AND role_type=0 AND is_deleted=0 AND package_name='erp.chain'
    </select>

    <select id="getRolePrivileges" resultType="BigInteger">
        SELECT DISTINCT(srpr.privilege_id)
        FROM s_user_role_r surr
        INNER JOIN s_role_privilege_r srpr
        ON surr.role_id=srpr.role_id
        AND surr.user_id=#{userId}
    </select>

    <select id="getUserPosRiv" resultType="mapUnderscoreToCamelCase">
        SELECT
        ru.user_id,
        rp.privilege_id
        FROM
        s_user_role_r ru
        INNER JOIN s_role_privilege_r rp
        ON ru.role_id = rp.role_id
        WHERE ru.user_id in(${uIds})
    </select>
</mapper>