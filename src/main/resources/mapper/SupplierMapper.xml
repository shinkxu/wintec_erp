<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="erp.chain.mapper.SupplierMapper">
    <resultMap id="BaseResultMap" type="erp.chain.domain.Supplier">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Fri Nov 04 15:05:01 CST 2016.
        -->
        <id column="id" property="id" jdbcType="BIGINT"/>
        <result column="tenant_id" property="tenantId" jdbcType="BIGINT"/>
        <result column="branch_id" property="branchId" jdbcType="BIGINT"/>
        <result column="supplier_code" property="supplierCode" jdbcType="VARCHAR"/>
        <result column="supplier_name" property="supplierName" jdbcType="VARCHAR"/>
        <result column="mnemonic" property="mnemonic" jdbcType="VARCHAR"/>
        <result column="status" property="status" jdbcType="TINYINT"/>
        <result column="contacts" property="contacts" jdbcType="VARCHAR"/>
        <result column="contacts_number" property="contactsNumber" jdbcType="VARCHAR"/>
        <result column="address" property="address" jdbcType="VARCHAR"/>
        <result column="memo" property="memo" jdbcType="VARCHAR"/>
        <result column="create_by" property="createBy" jdbcType="VARCHAR"/>
        <result column="create_at" property="createAt" jdbcType="TIMESTAMP"/>
        <result column="last_update_by" property="lastUpdateBy" jdbcType="VARCHAR"/>
        <result column="last_update_at" property="lastUpdateAt" jdbcType="TIMESTAMP"/>
        <result column="is_deleted" property="isDeleted" jdbcType="BIT"/>
    </resultMap>

    <sql id="pageFoot">
        LIMIT ${offset},${rows}
    </sql>

    <!--查询供应商列表-->
    <sql id="querySupplierListHead">
        SELECT count(1) FROM (
    </sql>
    <sql id="querySupplierListMain">
        SELECT * FROM supplier s WHERE s.is_deleted = 0 AND s.tenant_id = ${tenantId}
        <!--<if test="branchId != null and branchId != ''">
            AND s.branch_id = ${branchId}
        </if>-->
        <if test="supplierCodeOrName != null and supplierCodeOrName != ''">
            AND (s.supplier_code LIKE '%${supplierCodeOrName}%' OR  s.supplier_name LIKE '%${supplierCodeOrName}%' OR s.mnemonic LIKE '%${supplierCodeOrName}%')
        </if>
        <if test="supplierStatus != null and supplierStatus != ''">
            AND s.status = ${supplierStatus}
        </if>
        <if test="onlySelf == 1">
            AND s.branch_id = ${branchId}
        </if>
        <if test="isSort != null and isSort == 1">
            ORDER BY s.last_update_at DESC
        </if>
    </sql>
    <sql id="querySupplierListFoot">
        ) t
    </sql>
    <select id="querySupplierList" resultType="mapUnderscoreToCamelCase">
        <include refid="querySupplierListMain"></include>
        <include refid="pageFoot"></include>
    </select>
    <select id="querySupplierListSum" resultType="java.lang.Long">
        <include refid="querySupplierListHead"></include>
        <include refid="querySupplierListMain"></include>
        <include refid="querySupplierListFoot"></include>
    </select>

    <!--通过ID和tenantId查询供应商-->
    <select id="findSupplierByIdAndTenantId" resultType="erp.chain.domain.Supplier">
        SELECT * FROM supplier WHERE is_deleted = 0 AND id = #{id} AND tenant_id = ${tenantId}
    </select>

    <!--新增供应商-->
    <insert id="insert" parameterType="map" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO supplier(id, tenant_id, branch_id, supplier_code, supplier_name, mnemonic, contacts, contacts_number, address, memo, status, create_by, create_at, last_update_by,
        last_update_at) VALUES (#{id,jdbcType=BIGINT}, #{tenantId,jdbcType=BIGINT}, #{branchId,jdbcType=BIGINT}, #{supplierCode,jdbcType=VARCHAR}, #{supplierName,jdbcType=VARCHAR},
        #{mnemonic,jdbcType=VARCHAR}, #{contacts,jdbcType=VARCHAR}, #{contactsNumber,jdbcType=VARCHAR}, #{address,jdbcType=VARCHAR}, #{memo,jdbcType=VARCHAR}, #{status,jdbcType=INTEGER},
        #{createBy,jdbcType=VARCHAR}, #{createAt,jdbcType=TIMESTAMP}, #{lastUpdateBy,jdbcType=VARCHAR}, #{lastUpdateAt,jdbcType=TIMESTAMP})
    </insert>

    <!--修改供应商-->
    <update id="update" parameterType="map">
        UPDATE supplier
        <set>
            <if test="supplierCode != null">
                supplier_code = #{supplierCode,jdbcType=VARCHAR},
            </if>
            <if test="supplierName != null">
                supplier_name = #{supplierName,jdbcType=VARCHAR},
            </if>
            <if test="mnemonic != null">
                mnemonic = #{mnemonic,jdbcType=VARCHAR},
            </if>
            <if test="contacts != null">
                contacts = #{contacts,jdbcType=VARCHAR},
            </if>
            <if test="contactsNumber != null">
                contacts_number = #{contactsNumber,jdbcType=VARCHAR},
            </if>
            <if test="address != null">
                address = #{address,jdbcType=VARCHAR},
            </if>
            <if test="memo != null">
                memo = #{memo,jdbcType=VARCHAR},
            </if>
            <if test="status != null">
                status = #{status,jdbcType=INTEGER},
            </if>
            <if test="lastUpdateBy != null">
                last_update_by = #{lastUpdateBy,jdbcType=VARCHAR},
            </if>
            <if test="lastUpdateAt != null">
                last_update_at = #{lastUpdateAt,jdbcType=TIMESTAMP}
            </if>
        </set>
        WHERE id = #{id,jdbcType=BIGINT} AND tenant_id = #{tenantId,jdbcType=BIGINT}
    </update>

    <!--查询是否有商品使用该供应商-->
    <select id="supplierToGoods" resultType="java.lang.Long">
        SELECT count(1) FROM goods WHERE supplier_id IN (${ids}) AND tenant_id = ${tenantId} AND branch_id = ${branchId} AND is_deleted = 0
    </select>

    <!--是否有未审核采购单使用该供应商-->
    <select id="supplierToStoreOrder" resultType="java.lang.Long">
        SELECT count(1) FROM store_order WHERE supplier_id IN (${ids}) AND tenant_id = ${tenantId} AND branch_id = ${branchId} AND is_deleted = 0
    </select>

    <!--删除供应商-->
    <update id="delSupplier">
        UPDATE supplier SET is_deleted = 1 WHERE id IN (${ids}) AND tenant_id = ${tenantId} AND branch_id = ${branchId}
    </update>


    <!--查询最大编码-->
    <select id="queryMaxCode" resultType="java.lang.String">
        SELECT MAX(s.supplier_code) code FROM supplier s WHERE s.tenant_id = ${tenantId} AND s.is_deleted = 0
    </select>

    <!--查询编码是否被使用-->
    <select id="isUsedCode" resultType="java.lang.Long">
        SELECT count(1) FROM supplier s WHERE s.tenant_id = ${tenantId} AND s.supplier_code = '${supplierCode}' AND s.is_deleted = 0
    </select>
</mapper>